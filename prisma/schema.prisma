// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role         String   @db.VarChar(50) // 'admin' or 'moderator'
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("users")
}

model Product {
  id            Int       @id @default(autoincrement())
  name          String    @db.VarChar(255)
  code          String    @unique @db.VarChar(100)
  description   String?   @db.Text
  basePriceBdt  Decimal   @map("base_price_bdt") @db.Decimal(10, 2)
  sellPriceBdt  Decimal   @map("sell_price_bdt") @db.Decimal(10, 2)
  imageUrl      String?   @map("image_url") @db.Text
  sourceLink    String?   @map("source_link") @db.Text
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")
  
  variantGroups VariantGroup[]
  orderItems    OrderItem[]

  @@index([code], map: "idx_products_code")
  @@index([isActive], map: "idx_products_active")
  @@map("products")
}

model VariantGroup {
  id                Int       @id @default(autoincrement())
  productId         Int       @map("product_id")
  color             String    @db.VarChar(100)
  sizes             String[]  // PostgreSQL array
  sellPriceOverride Decimal?  @map("sell_price_override") @db.Decimal(10, 2)
  imageUrl          String?   @map("image_url") @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId], map: "idx_variant_groups_product_id")
  @@map("variant_groups")
}

model Customer {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  phone       String    @db.VarChar(20)
  email       String?   @db.VarChar(255)
  address     String?   @db.Text
  city        String?   @db.VarChar(100)
  zone        String?   @db.VarChar(100)
  area        String?   @db.VarChar(100)
  postalCode  String?   @map("postal_code") @db.VarChar(20)
  country     String?   @db.VarChar(100)
  website     String?   @db.Text
  totalOrders Int      @default(0) @map("total_orders")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  
  orders Order[]

  @@index([phone], map: "idx_customers_phone")
  @@map("customers")
}

model Order {
  id                Int       @id @default(autoincrement())
  customerId        Int       @map("customer_id")
  status            String    @default("pending") @db.VarChar(50) // pending, confirmed, processing, shipped, delivered, cancelled
  address           String    @db.Text
  deliveryChargeBdt Decimal  @default(0) @map("delivery_charge_bdt") @db.Decimal(10, 2)
  advanceBdt        Decimal   @default(0) @map("advance_bdt") @db.Decimal(10, 2)
  dueBdt           Decimal   @default(0) @map("due_bdt") @db.Decimal(10, 2)
  pathaoCityName   String?   @map("pathao_city_name") @db.VarChar(100)
  pathaoZoneName   String?   @map("pathao_zone_name") @db.VarChar(100)
  pathaoAreaName   String?   @map("pathao_area_name") @db.VarChar(100)
  pathaoTrackingCode String? @map("pathao_tracking_code") @db.VarChar(255)
  pathaoStatus     String?   @map("pathao_status") @db.VarChar(100)
  lastSyncedAt     DateTime? @map("last_synced_at")
  totalAmount      Decimal   @map("total_amount") @db.Decimal(10, 2)
  totalItems       Int       @default(0) @map("total_items")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at")
  
  customer    Customer     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  orderItems  OrderItem[]
  batchOrders BatchOrder[]

  @@index([customerId], map: "idx_orders_customer_id")
  @@index([status], map: "idx_orders_status")
  @@map("orders")
}

model OrderItem {
  id                     Int       @id @default(autoincrement())
  orderId                Int       @map("order_id")
  productId              Int       @map("product_id")
  productNameSnapshot    String    @map("product_name_snapshot") @db.VarChar(255)
  imageUrlSnapshot      String?   @map("image_url_snapshot") @db.Text
  colorSnapshot          String?   @map("color_snapshot") @db.VarChar(100)
  sizeSnapshot           String?   @map("size_snapshot") @db.VarChar(50)
  qty                    Int
  sellPriceBdtSnapshot   Decimal   @map("sell_price_bdt_snapshot") @db.Decimal(10, 2)
  price                  Decimal   @db.Decimal(10, 2)
  quantity               Int
  createdAt              DateTime  @default(now()) @map("created_at")
  
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId], map: "idx_order_items_order_id")
  @@index([productId], map: "idx_order_items_product_id")
  @@map("order_items")
}

model Batch {
  id        Int          @id @default(autoincrement())
  note      String?      @db.Text
  createdBy String       @map("created_by") @db.VarChar(255)
  createdAt DateTime     @default(now()) @map("created_at")
  
  batchOrders BatchOrder[]

  @@map("batches")
}

model BatchOrder {
  batchId Int   @map("batch_id")
  orderId Int   @map("order_id")
  
  batch Batch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@id([batchId, orderId])
  @@index([batchId], map: "idx_batch_orders_batch_id")
  @@index([orderId], map: "idx_batch_orders_order_id")
  @@map("batch_orders")
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(255)
  value     Json
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("settings")
}
